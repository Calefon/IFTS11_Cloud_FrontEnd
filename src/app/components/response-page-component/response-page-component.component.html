<div class="flex flex-col gap-4 items-center h-full p-4">

  <!-- Estado de carga -->
  @if (isLoading) {
    <div class="text-center py-8 italic text-gray-500">
      <span class="inline-block animate-spin">‚è≥</span> Cargando datos...
    </div>
  }

  <!-- Mensajes de error -->
  @if (errorMessage) {
    <div class="w-full p-4 bg-red-50 text-red-600 rounded-lg border border-red-200">
      {{ errorMessage }}
    </div>
  }

  <!-- Informaci√≥n de la encuesta -->
  @if (encuesta) {
    <div class="w-full bg-white p-4 rounded-lg shadow-md border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-800 mb-1">{{ encuesta.titulo }}</h2>
      <div class="flex flex-wrap gap-4 text-sm text-gray-600">
        <p><span class="font-medium">Cliente:</span> {{ encuesta.InquiroPK }}</p>
        <p><span class="font-medium">Fecha creaci√≥n:</span> {{ encuesta.fechaCreacion }}</p>
        <p><span class="font-medium">Total respuestas:</span> {{ respuestas.length }}</p>
      </div>
    </div>
  }

  <!-- Bot√≥n de descarga -->
  <button
    (click)="descargarCSV()"
    [disabled]="!respuestas.length"
    class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
    Descargar CSV
  </button>

  @if (respuestas.length) {
    <div class="w-full overflow-x-auto shadow-sm rounded-lg border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            @for (pregunta of encuesta?.preguntas || []; track $index) {
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                {{ pregunta.pregunta }}
                @if (pregunta.tipoPregunta) {
                  <span class="block text-xs text-gray-400 font-normal">{{ pregunta.tipoPregunta }}</span>
                }
              </th>
            }
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          @for (respuesta of respuestas; track $index; let i = $index) {
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ i + 1 }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ respuesta.fecha | date:'medium' }}
              </td>
              @for (pregunta of encuesta?.preguntas || []; track $index) {
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  @if (respuesta.respuestas[pregunta.pregunta]) {
                    @if (esArray(respuesta.respuestas[pregunta.pregunta])) {
                      <ul class="list-disc list-inside">
                        @for (opcion of respuesta.respuestas[pregunta.pregunta]; track $index) {
                          <li>{{ opcion }}</li>
                        }
                      </ul>
                    } @else {
                      {{ respuesta.respuestas[pregunta.pregunta] }}
                    }
                  } @else {
                    <span class="text-red-300">No encontrada</span>
                  }
                </td>
              }
            </tr>
          }
        </tbody>
      </table>
    </div>
  } @else if (!isLoading && encuesta) {
    <div class="text-center py-8 text-gray-400">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <p class="mt-2 text-lg">No se encontraron respuestas para esta encuesta</p>
      <p class="text-sm">Las respuestas aparecer√°n aqu√≠ una vez que los participantes respondan</p>
    </div>
  }

  <!-- Secci√≥n de an√°lisis y gr√°ficos -->
  <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 w-full">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800">üìä Gr√°ficos y Estad√≠sticas</h3>
      <button
        (click)="toggleGraficos()"
        class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
        {{ mostrandoGraficos ? 'Ocultar' : 'Ver Gr√°ficos' }}
      </button>
    </div>

    @if (mostrandoGraficos) {
      @if (cargandoGraficos) {
        <div class="text-center py-4 italic text-gray-500">
          <span class="inline-block animate-spin">‚è≥</span> Cargando gr√°ficos...
        </div>
      } @else {
        @if (graficosResponse) {
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Resumen general -->
            <div class="bg-gray-50 p-4 rounded border">
              <h4 class="font-medium mb-3 text-center">Resumen de Respuestas</h4>
              <div class="text-center">
                <div class="text-3xl font-bold text-green-600 mb-2">{{ respuestas.length }}</div>
                <p class="text-sm text-gray-600">respuestas recibidas</p>
                <p class="text-xs text-gray-500 mt-1">Total de participantes</p>
              </div>
            </div>

            <!-- Gr√°ficos por pregunta -->
            @for (grafico of getPreguntasRadio(); track $index) {
              <div class="bg-gray-50 p-4 rounded border flex flex-col items-center">
                <h4 class="font-medium mb-3 text-center">
                  {{ grafico.titulo || ('Pregunta ID: ' + (grafico.preguntaId || $index)) }}
                </h4>

                @if (grafico.datos && grafico.datos.length) {
                  <div class="w-full max-w-xs h-64 mb-4">
                    <canvas [id]="'pastel-' + (grafico.preguntaId || $index)" class="w-full h-full"></canvas>
                  </div>

                  <div class="space-y-2 w-full max-w-xs">
                    @for (dato of grafico.datos; track $index) {
                      <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                          <div class="w-3 h-3 rounded-full flex-shrink-0"
                               [style.background]="dato.color || getColorPorIndice($index)"></div>
                          <span>{{ dato.label || 'Opci√≥n' }}</span>
                        </div>
                        <span class="font-medium">
                          {{ dato.porcentaje || 0 }}% ({{ dato.value }})
                        </span>
                      </div>
                    }
                  </div>
                } @else {
                  <p class="text-center italic text-gray-500">No hay datos para esta pregunta.</p>
                }
              </div>
            }
          </div>
        } @else {
          <div class="text-center text-gray-500 italic py-4">
            No se encontraron datos de gr√°ficos para esta encuesta.
          </div>
        }
      }
    }
  </div>

  <!-- Secci√≥n IA -->
  <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 w-full">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800"> An√°lisis con IA</h3>
      <div class="flex gap-2">
        <button
          (click)="generarAnalisisIA()"
          [disabled]="cargandoAnalisis"
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm disabled:bg-gray-300">
          {{ cargandoAnalisis ? 'Analizando...' : 'An√°lisis IA' }}
        </button>
        <button
          (click)="toggleAnalisis()"
          class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
          {{ mostrandoAnalisis ? 'Ocultar' : 'Mostrar' }}
        </button>
      </div>
    </div>

    @if (cargandoAnalisis) {
      <div class="text-center py-4 italic text-gray-500">
        <span class="inline-block animate-spin">‚è≥</span> Generando an√°lisis...
      </div>
    }

   @if (mostrandoAnalisis && analisis) {
      <div class="space-y-4">

        <!-- Mostrar texto principal del an√°lisis -->
        @if (analisis.analisis) {
          <div class="bg-gray-50 p-3 rounded border border-gray-200">
            <h4 class="font-medium text-gray-800 mb-1">An√°lisis Detallado</h4>
            
            <!-- ‚úÖ SI ES OBJETO, EXTRAER EL TEXTO -->
            @if (typeof analisis.analisis === 'object') {
              <p class="text-gray-700 whitespace-pre-line">{{ analisis.analisis.analisis_texto || 'An√°lisis en formato objeto' }}</p>
            } 
            <!-- ‚úÖ SI ES STRING, MOSTRAR DIRECTAMENTE -->
            @else {
              <p class="text-gray-700 whitespace-pre-line">{{ analisis.analisis }}</p>
            }
          </div>
        } @else if (analisis.analisis_texto) {
          <div class="bg-gray-50 p-3 rounded border border-gray-200">
            <h4 class="font-medium text-gray-800 mb-1">An√°lisis Detallado</h4>
            <p class="text-gray-700 whitespace-pre-line">{{ analisis.analisis_texto }}</p>
          </div>
        } @else {
          <p class="text-center italic text-gray-500">
            No se encontr√≥ texto de an√°lisis para esta encuesta.
          </p>
        }

      </div>
    }
  </div>

</div>